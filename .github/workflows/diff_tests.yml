name: Diff test outputs

on:
  pull_request:
    branches:
      - '*'

jobs:
  start-runner:
    name: Start self-hosted EC2 runner (Linux)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ec2:
          - { ami: ami-0610b26d76319237e, instance-type: m6i.8xlarge}
    outputs:
      label: ${{ steps.start-ec2-runner.outputs.label }}
      ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: machulav/ec2-github-runner@v2
        with:
          mode: start
          github-token: ${{ secrets.ACCESS_TOKEN }}
          ec2-image-id: ${{ matrix.ec2.ami }}
          ec2-instance-type: ${{ matrix.ec2.instance-type }}
          subnet-id: subnet-0deb935f0bbfe1a5d
          security-group-id: sg-0f6a02eb80fafb982
          aws-resource-tags: > # optional, requires additional permissions
            [
              {"Key": "Name", "Value": "ec2-github-runner"},
              {"Key": "GitHubRepository", "Value": "${{ github.repository }}"}
            ]
  do-the-job:
    strategy:
      fail-fast: false
      matrix:
        image:
          - { name: 'ubuntu', tag: '20.04', codename: 'focal' }
        llvm: [ '14' ]
        common_base: [ 'https://github.com/lifting-bits/cxx-common/releases/latest/download' ]
    
    env:
      CC: clang-${{ matrix.llvm }}
      CXX: clang++-${{ matrix.llvm }}

    name: Diff in ouput between old and new rellic
    needs: start-runner # required to start the main job when the runner is ready
    runs-on: ${{ needs.start-runner.outputs.label }} # run the job on the newly created runner
    container:
      image: docker.pkg.github.com/lifting-bits/cxx-common/vcpkg-builder-${{ matrix.image.name }}:${{ matrix.image.tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Adding github workspace as safe directory
        # See issue https://github.com/actions/checkout/issues/760
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Fetch merge
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true
      - name: Fetch base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0
          submodules: true
          path: old
      - name: Install utility tools
        shell: bash
        run: |
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
          echo "deb http://apt.llvm.org/${{ matrix.image.codename }}/ llvm-toolchain-${{ matrix.image.codename }}-${{ matrix.llvm }} main" >> /etc/apt/sources.list
          echo "deb-src http://apt.llvm.org/${{ matrix.image.codename }}/ llvm-toolchain-${{ matrix.image.codename }}-${{ matrix.llvm }} main" >> /etc/apt/sources.list
          apt-get update
          apt-get install -y pixz xz-utils make rpm python3.8 clang-${{ matrix.llvm }}
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 100
      - name: Download cxx-commons
        shell: bash
        run: |
          curl ${{ matrix.common_base }}/vcpkg_${{ matrix.image.name }}-${{ matrix.image.tag }}_llvm-${{ matrix.llvm }}_amd64.tar.xz \
              -L -o vcpkg_${{ matrix.image.name }}-${{ matrix.image.tag }}_llvm-${{ matrix.llvm }}_amd64.tar.xz
          tar xf vcpkg_${{ matrix.image.name }}-${{ matrix.image.tag }}_llvm-${{ matrix.llvm }}_amd64.tar.xz

      - name: Build old rellic
        shell: bash
        run: |
          cmake -S old -B rellic-build-old -DVCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg_${{ matrix.image.name }}-${{ matrix.image.tag }}_llvm-${{ matrix.llvm }}_amd64
          cmake --build rellic-build-old

      - name: Build new rellic
        shell: bash
        run: |
          cmake -S . -B rellic-build -DVCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg_${{ matrix.image.name }}-${{ matrix.image.tag }}_llvm-${{ matrix.llvm }}_amd64
          cmake --build rellic-build

      - name: Print job summary
        shell: bash
        run: |
          echo "# Test diffs" >> $GITHUB_STEP_SUMMARY
          cd $GITHUB_WORKSPACE/tests/tools/decomp
          env CLANG=clang-14 \
              OLD_RELLIC=$GITHUB_WORKSPACE/rellic-build-old/tools/rellic-decomp \
              NEW_RELLIC=$GITHUB_WORKSPACE/rellic-build/tools/rellic-decomp \
              make -s -j1 -f diff_outputs.mk >> $GITHUB_STEP_SUMMARY

      - name: Output generated markdown
        shell: bash
        id: md
        run: |
          cd $GITHUB_WORKSPACE/tests/tools/decomp
          env CLANG=clang-14 \
              OLD_RELLIC=$GITHUB_WORKSPACE/rellic-build-old/tools/rellic-decomp \
              NEW_RELLIC=$GITHUB_WORKSPACE/rellic-build/tools/rellic-decomp \
              make -s -j1 -f diff_outputs.mk >> $GITHUB_WORKSPACE/test-diff.md

      - name: Add comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('test-diff.md', {encoding:'utf-8'})
            const message = `See the diff generated by this PR for the tests here: https://github.com/lifting-bits/rellic/actions/runs/${{ github.run_id }}
            <details>

            ${body}

            </details>`

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
